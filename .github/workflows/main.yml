name: RDP

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 15

    steps:
      - name: Download ngrok
        run: |
          Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip -Force
          .\ngrok.exe authtoken $env:NGROK_AUTH_TOKEN
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Enable RDP & create temp admin user
        shell: powershell
        run: |
          # generate a random password
          $pw = [System.Web.Security.Membership]::GeneratePassword(14,3)
          Write-Host "Generated password (hidden for security)"
          net user temp_rdp_user $pw /add
          net localgroup administrators temp_rdp_user /add
          # enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          # save password in env (in-memory only)
          setx TEMP_RDP_PASS $pw

      - name: Start ngrok (background) and show tunnel
        shell: powershell
        run: |
          # start ngrok tcp tunnel
          Start-Process -FilePath .\ngrok.exe -ArgumentList "tcp 3389" -NoNewWindow
          Start-Sleep -Seconds 4
          try {
            $tunnels = Invoke-RestMethod http://127.0.0.1:4040/api/tunnels -ErrorAction Stop
            $tcp = $tunnels.tunnels | Where-Object { $_.proto -eq 'tcp' } | Select-Object -First 1
            if ($null -ne $tcp) {
              Write-Host "Ngrok TCP forwarding: $($tcp.public_url)"
            } else {
              Write-Host "No TCP tunnel found. API output:"
              $tunnels | ConvertTo-Json -Depth 5
              exit 1
            }
          } catch {
            Write-Host "Could not reach ngrok API:" $_.Exception.Message
            exit 1
          }

      - name: Keep job alive briefly (example: 5 minutes) while you connect
        shell: powershell
        run: |
          Write-Host "Sleeping 5 minutes to allow RDP connection..."
          Start-Sleep -Seconds 300

      - name: Cleanup temp user
        if: always()
        shell: powershell
        run: |
          net user temp_rdp_user /delete
          Write-Host "temp_rdp_user deleted (if existed)."
